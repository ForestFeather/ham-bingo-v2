var region0 = [
    'MN Minnesota',
    'IA Iowa',
    'CO Colorado',
    'KS Kansas',
    'MO Missouri',
    'NE Nebraska',
    'ND North Dakota',
    'SD South Dakota'
];

var region1 = [
    'CT Connecticut',
    'EMA Eastern Massachusetts',
    'WMA Western Massachusetts',
    'ME Maine',
    'NH New Hampshire',
    'RI Rhode Island',
    'VT Vermont'
];

var region2 = [
    'ENY Eastern New York',
    'NLI New York City - Long Island',
    'NNJ Northern New Jersey',
    'NNY Northern New York',
    'SNJ Southern New Jersey',
    'WNY Western New York'
];

var region3 = [
    'DE Delaware',
    'EPA Eastern Pennsylvania',
    'MDC Maryland - DC',
    'WPA Western Pennsylvania'
];

var region4 = [
    'AL Alabama',
    'GA Georgia',
    'KY Kentucky',
    'NC North Carolina',
    'NFL Northern Florida',
    'SC South Carolina',
    'SFL Southern Florida',
    'WCF West Central Flordia',
    'TN Tennessee',
    'VA Virginia',
    'PR Puerto Rico',
    'VI Virgin Islands'
];

var region5 = [
    'AK Arkansas',
    'LA Louisiana',
    'MS Mississippi',
    'NM New Mexico',
    'NTX North Texas',
    'OK Oklahoma',
    'STX South Texas',
    'WTX West Texas'
];

var region6 = [
    'EB East Bay',
    'LAX Los Angeles',
    'ORG Orange County',
    'SB Santa Barbara',
    'SCV Santa Clara Valley',
    'SDG San Diego',
    'SF San Fransisco',
    'SJV San Joaquin Valley',
    'SV Sacramento Valley',
    'PAC Pacific'
];

var region7 = [
    'AZ Arizona',
    'EWA Eastern Washington',
    'ID Idaho',
    'MT Montana',
    'NV Nevada',
    'OR Oregon',
    'UT Utah',
    'WWA Western Washington',
    'WY Wyoming',
    'AK Alaska'
];

var region8 = [
    'MI Michigan',
    'OH Ohio',
    'WV West Virginia'
];

var region9 = [
    'IL Illinois',
    'IN Indiana',
    'WI Wisconsin'
];

var canadaRegions = [
    'MAR Maritime',
    'NL Newfoundland / Labrador',
    'PE Prince Edward Island',
    'QC Quebec',
    'ONN Ontario North',
    'ONS Ontario South',
    'ONE Ontario East',
    'GTA Greater Toronto Area',
    'MB Manitoba',
    'SK Saskatchewan',
    'AB Alberta',
    'BC British Columbia',
    'NT Northern Territories'
];

var generalRegions = [
    'ITU Region 1',
    'ITU Region 2',
    'ITU Region 3'
];

var arrlDivisions = [
    'Atlantic Division',
    'Central Division',
    'Dakota Division',
    'Delta Division',
    'Great Lakes Division',
    'Hudson Division',
    'Midwest Division',
    'New England Division',
    'Northwestern Division',
    'Pacific Division',
    'Roanoke Division',
    'Rocky Mountain Division',
    'Southeastern Division',
    'Southwestern Division',
    'West Gulf Division'
];

var continents = [
    'North America',
    'South America',
    'Europe',
    'Africa',
    'Asia',
    'Oceania'
];

var distances = [
    'Contact 1-5 Miles Away',
    'Contact 5-15 Miles Away',
    'Contact 15-40 Miles Away',
    'Contact 40-75 Miles Away',
    'Contact 75-120 Miles Away',
    'Contact 120-200 Miles Away',
    'Contact 200-300 Miles Away',
    'Contact 300-500 Miles Away',
    'Contact 500-750 Miles Away',
    'Contact 750-1000 Miles Away',
    'Contact 1000-1500 Miles Away',
    'Contact 1500-2000 Miles Away',
    'Contact 2000-3000 Miles Away',
    'Contact 3000-5000 Miles Away',
    'Contact 5000-8000 Miles Away',
    'Contact >8000 Miles Away'
];

var modeCounts = [
    'Make 1 CW contact',
    'Make 5 CW contacts',
    'Make 1 SSB contact',
    'Make 5 SSB contacts',
    'Make 1 AM contact',
    'Make 5 AM contacts',
    'Make 1 digital contact',
    'Make 5 digital contacts',
    'Make 1 satellite contact',
    'Make 5 satellite contacts'
];

var bandsHF = [
    'Contact on 160m',
    'Contact on 80m',
    'Contact on 40m',
    'Contact on 20m',
    'Contact on 15m',
    'Contact on 10m'
];

var bandsUHFVHF = [
    'Contact on 6m',
    'Contact on 2m',
    'Contact on 1.25m',
    'Contact on 70cm'
];

var bandsWARC = [
    'Contact on 60m',
    'Contact on 30m',
    'Contact on 17m',
    'Contact on 12m'
];

var specialProtocols = [
    'Contact with CW',
    'Contact with AM',
    'Contact with SSB',
    'Contact with AM',
    'Contact with FM',
    'Contact with FT4/8',
    'Contact with PSK31',
    'Contact with APRS'
];

var locationChallenges = [
    'Contact with Maritime station',
    'Contact with Mobile station',
    'Contact with Aeronautical station',
    'Contact with International Space Station',
    'Contact with a Military Station',
    'Contact with a National Park',
    'Contact with a State Park',
    'Contact with a Summit on the Air',
    'Contact with an Island on the Air',
    'Contact with a Lighthouse / Lightship',
    'Contact with a Special Event Station',
    'Contact with W1AW'
];

var clubChallenges = [
    'Contact with 1 club member',
    'Contact with 5 club members',
    'Contact with 10 club members',
    'Contact with a nearby club',
    'Contact with a distant club',
    'Contact with a national club',
    'Contact with an international club'
];

var contactCounts = [
    '1 Contact',
    '2 Contacts',
    '5 Contacts',
    '10 Contacts',
    '15 Contacts',
    '20 Contacts',
    '25 Contacts',
    '50 Contacts',
    '75 Contacts',
    '100 Contacts'
];

var contactCountsTimed = [
    '5 contacts in 10 minutes',
    '10 contacts in 10 minutes',
    '30 contacts in an hour',
    '100 contacts in 3 hours',
    '300 contacts in 6 hours',
    '500 contacts in 8 hours',
    '1000 contacts in 24 hours'
];

var stationClasses = [
    'Contact with a Class A station',
    'Contact with a Class B station',
    'Contact with a Class C station',
    'Contact with a Class D station',
    'Contact with a class E station',
    'Contact with a class F station',
    'Contact with a QRP station'
];

var bonusPoints = [
    'Use 100% Emergency Power',
    'Originate a Formal Message to Section Manager',
    'Relay a formal message',
    'Make a satellite QSO',
    'Make 5 contacts using alternate power source',
    'Copy a W1AW bulletin',
    'Submit field day entry via web',
    'Participate with a youth',
    'Promote your operation via social media',
    'Declare a safety officer for your operation'
];

var socialPoints = [
    'Obtain publicity from local media',
    'Operate from a public location',
    'Provide public information'
];

var listOfCategories = {
    'Region 0': region0,
    'Region 1': region1,
    'Region 2': region2,
    'Region 3': region3,
    'Region 4': region4,
    'Region 5': region5,
    'Region 6': region6,
    'Region 7': region7,
    'Region 8': region8,
    'Region 9': region9,
    'Canada Regions': canadaRegions,
    'General Regions': generalRegions,
    'ARRL Divisions': arrlDivisions,
    'Continents': continents,
    'Distances': distances,
    'Mode Counts': modeCounts,
    'HF Bands': bandsHF,
    'VHF/UHF Bands': bandsUHFVHF,
    'WARC Bands': bandsWARC,
    'Special Protocols': specialProtocols,
    'Location Challenges': locationChallenges,
    'Club Challenges': clubChallenges,
    'Contact Counts': contactCounts,
    'Timed Counts': contactCountsTimed,
    'Station Classes': stationClasses,
    'Bonus Points': bonusPoints,
    'Social Points': socialPoints,
};


var emptyLines = [];
var linesCopy = buildLines();
var seed;
var rng = new Math.seedrandom();

function buildLines(custom=true, filterBy='') {
    var lines = [];
    for (var [key, value] of Object.entries(listOfCategories)) {
        var checkbox = document.getElementById(key);
        if(checkbox == null || checkbox.checked == true && ( filterBy == '' || key.includes(filterBy) ) ) {
            lines = lines.concat(value);
        }
    }

    // Add custom items, if enabled
    if(custom == true && document.getElementById("customItemsEnable").checked == true) {
        var customItems = document.getElementById("customItems").value.split(',');
        lines = lines.concat(customItems);
    }
    
    return lines.filter(Boolean).slice();
}

function newSeed() {
    var seedField = document.getElementById("seed");
    rng = new Math.seedrandom();
    seedField.value = Math.abs(rng.int32());
}

function initAll() {
    if (document.getElementById) {
        newSeed();
        newCard();
    } else {
        alert("Your browser does not support this script.");
    }
}

function newCard() {
    rng = new Math.seedrandom(document.getElementById("seed").value);
    linesCopy = buildLines();

    if ( linesCopy.length < 24 ) {
        alert("You do not have enough items selected to generate a full bingo card.  Please add more selections and try again.");
        return false;
    }

    for (var i = 0; i < 24; i++) {
        setSquare(i);
    }
}

function setSquare(thisSquare) {
    var currentSquare = "square" + thisSquare;

    var randomString = getRandomStringAndRemove(thisSquare);
    document.getElementById(currentSquare).innerHTML = randomString;
}

function getRandomStringAndRemove(thisSquare) {
    var randomIndex = Math.floor(rng() * (linesCopy.length - thisSquare) ) + 1;
    var randomString = linesCopy.splice(randomIndex, 1);
    return randomString;
}

function anotherCard() {
    newCard();

    document.getElementById("Card").scrollIntoView();

    return false;
}

function generateComboCard() {
    var count = 0;
    var bands = document.getElementById("comboBands").checked == true;
    var regions = document.getElementById("comboRegions").checked == true;
    var counts = document.getElementById("comboContactCounts").checked == true;
    var modes = document.getElementById("comboModes").checked == true;
    var custom = document.getElementById("comboCustom").checked == true;
    if ( bands ) count++;
    if ( regions ) count++;
    if ( counts ) count++;
    if ( modes ) count++;
    if ( custom ) count++;

    if ( count < 2 || count > 3 ) {
        alert("An invalid number of items have been selected.  Please adjust selections and try again.");
        return false;
    }

    // Start building the lists
    var comboList = [];
    if ( regions ) comboList.push(buildLines(false,'Region'));
    if ( bands ) { 
        var tempBands = buildLines(false,'Bands');

        for(var i = 0; i < tempBands.length; i++) { tempBands[i] = tempBands[i].replace('Contact on ',''); }

        comboList.push(tempBands);
    }
    if ( counts ) comboList.push(['1 Contacts', '1 Contacts', '2 Contacts', '2 Contacts', '3 Contacts', '3 Contacts', '3 Contacts', '5 Contacts', '5 Contacts', '5 Contacts', '10 Contacts', '10 Contacts', '10 Contacts', '15 Contacts', '15 Contacts', '20 Contacts', '25 Contacts', '30 Contacts']);
    if ( modes ) comboList.push(['CW', 'Voice', 'Digital']);
    if ( custom ) comboList.push(buildLines(true,'#GARBAGE#'));

    // Now to create the actual card list
    linesCopy = combineArrays(comboList);

    // Make sure we have enouch combos
    if ( linesCopy.length < 24 ) {
        alert("Your chosen combination of categories do not have enough combinations to fill a bingo card.  Please select more items.");
        return false;
    }

    // And populate the card
        for (var i = 0; i < 24; i++) {
           setSquare(i);
        }


    document.getElementById("Card").scrollIntoView();

    return false;
}

function combineArrays( array_of_arrays ){

    // First, handle some degenerate cases...

    if( ! array_of_arrays ){
        // Or maybe we should toss an exception...?
        return [];
    }

    if( ! Array.isArray( array_of_arrays ) ){
        // Or maybe we should toss an exception...?
        return [];
    }

    if( array_of_arrays.length == 0 ){
        return [];
    }

    for( let i = 0 ; i < array_of_arrays.length; i++ ){
        if( ! Array.isArray(array_of_arrays[i]) || array_of_arrays[i].length == 0 ){
            // If any of the arrays in array_of_arrays are not arrays or zero-length, return an empty array...
            return [];
        }
    }

    // Done with degenerate cases...

    // Start "odometer" with a 0 for each array in array_of_arrays.
    let odometer = new Array( array_of_arrays.length );
    odometer.fill( 0 );

    let output = [];

    let newCombination = formCombination( odometer, array_of_arrays );

    output.push( newCombination );

    while ( odometer_increment( odometer, array_of_arrays ) ){
        newCombination = formCombination( odometer, array_of_arrays );
        output.push( newCombination );
    }

    return output;
}/* combineArrays() */


// Translate "odometer" to combinations from array_of_arrays
function formCombination( odometer, array_of_arrays ){
    // In Imperative Programmingese (i.e., English):
     let s_output = "";
     for( let i=0; i < odometer.length; i++ ){
        s_output += (i == 0 ? "" : "<br />" ) + array_of_arrays[i][odometer[i]];
     }
     return s_output;

    // In Functional Programmingese (Henny Youngman one-liner):
    //return odometer.reduce(
    //  function(accumulator, odometer_value, odometer_index){
    //    return "" + accumulator + array_of_arrays[odometer_index][odometer_value];
    //  },
    //  ""
    //);
}/* formCombination() */

function odometer_increment( odometer, array_of_arrays ){

    // Basically, work you way from the rightmost digit of the "odometer"...
    // if you're able to increment without cycling that digit back to zero,
    // you're all done, otherwise, cycle that digit to zero and go one digit to the
    // left, and begin again until you're able to increment a digit
    // without cycling it...simple, huh...?

    for( let i_odometer_digit = odometer.length-1; i_odometer_digit >=0; i_odometer_digit-- ){

        let maxee = array_of_arrays[i_odometer_digit].length - 1;

        if( odometer[i_odometer_digit] + 1 <= maxee ){
            // increment, and you're done...
            odometer[i_odometer_digit]++;
            return true;
        }
        else{
            if( i_odometer_digit - 1 < 0 ){
                // No more digits left to increment, end of the line...
                return false;
            }
            else{
                // Can't increment this digit, cycle it to zero and continue
                // the loop to go over to the next digit...
                odometer[i_odometer_digit]=0;
                continue;
            }
        }
    }/* for( let odometer_digit = odometer.length-1; odometer_digit >=0; odometer_digit-- ) */

}/* odometer_increment() */
